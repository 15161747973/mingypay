<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" name="referrer" content="no-referrer">
    <title>基本信息</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">
</head>
<style>
    .colors {
        background-color: #eceff1
    }

    .contentCenter {
        width: 81%;
        padding: 10px;
        /*background-color: #9c78fc;*/
        background-color: #3f97e1;
        margin-top: 20px;
        margin-left: 130px;
        border-radius: 6px;
    }

    .contentCenters {
        width: 81%;
        padding: 10px;
        /*background-color: #9c78fc;*/
        background-color: #3f97e1;
        margin-top: 20px;
        margin-left: 130px;
        border-radius: 6px;
    }

    .btn {
        margin-top: 15px;
        margin-left: 15px
    }

    .notice {
        /*margin-left: 130px;*/
        color: red
    }

    .notice span {
        color: #6967ce
    }

    #uploadImage{margin-left: 125px;width: 60%;
        margin-top: 10px;}

    .popup_main{
        width: 470px;height: 368px;position: fixed;top: 30%;left: 50%;transform: translate(-50%,-50%);
        box-shadow: 0 0 15px black;
        background-color: #FFFFFF;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        padding: 15px;
        visibility: hidden;
    }
    .popup_main .delete_tip{
        color: #464855;
        font-size: 18px;
        text-align: right;
        /*padding: 15px 15px 0 0;*/
        padding-bottom: 15px;
    }
    .phone_number_box p{
        color: #2b335e;
        font-size: 14px;
    }
    .phone_number_box input{
        width: 90%;
        border: 1px solid #cacfe7;
        border-radius: 5px;
        /*height: 40px;*/
        padding: 10px 21px;
        background-color: #eceff1;
        margin-top: 10px;
    }
    .send_code_btn{
        cursor: pointer;
        padding: 7px 15px;
        margin-top: 5px;
    }
    .bottom_btn_box{
        margin-top: 25px;
    }
    .bottom_btn_box p{
        float: right;
        padding: 10px 20px;
        background-color: #dddddd;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        cursor: pointer;
    }

    .bgColor {
        display: none;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #000000;
        opacity: 0.3;
    }

    #payment_term[aria-readonly]{color:red;opacity:1}
</style>
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <form action="" class="layui-form" lay-filter="userForm" id="userForm">
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">商户信息</div>
                    <div class="layui-card-body" pad15>
                        <div class="layui-form" wid100 lay-filter="">
                            <div class="layui-form-item">
                                <label class="layui-form-label">商户名称</label>
                                <div class="layui-input-block">
                                    <input type="text" name="user_name" id="shop_name" readonly value="" class="layui-input colors">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">电子邮件</label>
                                <div class="layui-input-block">
                                    <input type="text" name="e_mail" id="email" readonly value="" class="layui-input colors">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">手机号码</label>
                                <div class="layui-input-block">
                                    <input type="text" id="phone_num" name="phone_number" readonly value="" class="layui-input colors">
                                </div>
                            </div>
                            <p class="layui-form-label">店铺链接</p>
                            <div class="contentCenter">
                                <a href="../../Purchase_page/goumai_page_main.html" target="_Blank" style="color: #FFFFFF;display: block">http://test.mingypay.com/Purchase_page/SSF66BC41180</a>
                                <p onclick="go_shopping()" class="layui-btn btn buttonStyles">更换商铺链接（慎点）</p>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">店铺短链接</label>
                                <div class="layui-input-block contentCenters">
                                    <p style="color: #FFFFFF;" id="short_link"></p>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">提现模式</label>
                                <div class="layui-input-block">
                                    <input type="radio" name="pay_type" value="1" title="手动提现" checked="">
                                    <input type="radio" name="pay_type" value="2" title="自动提现">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">客户QQ</label>
                                <div class="layui-input-block">
                                    <input lay-verify="user_qq" type="text" id="qq_num" name="user_qq" value="" class="layui-input">
                                    <p class="notice">(虚假QQ号或无法添加好友,平台将会直接冻结账户,QQ没开通在线会话的<span>点我开通</span>)</p>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">商户名称</label>
                                <div class="layui-input-block">
                                    <input type="text" lay-verify="user_name" name="shop_name" class="layui-input" placeholder="请填写商铺名称">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">站点网址</label>
                                <div class="layui-input-block" style="display: flex">
                                    <p style="padding-top: 6px;padding-left: 5px;padding-right: 5px;background-color: #eceff1;">http://</p>
                                    <input type="text" name="my_link" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">商家公告</label>
                                <div class="layui-input-block">
                                    <textarea name="shop_natice" class="layui-textarea"></textarea>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn buttonStyle" lay-submit lay-filter="submit_data">提交</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="layui-col-md6">
            <div class="layui-card" style="margin-top: -15px">
                <div class="layui-card-header">商户收款信息</div>
                <form action="" lay-filter="paymentTerm" class="layui-form" id="paymentTerm" enctype="multipart/form-data">
                    <div class="layui-card-body" pad15>
                        <div class="layui-form" wid100 lay-filter="">
                            <div class="layui-form-item">
                                <label class="layui-form-label">收款方式</label>
                                <div class="layui-input-block">
                                    <select id="payment_term"  name="gath_type" lay-filter="billing_method">
                                        <option value="1">支付宝</option>
                                        <option value="3">微信</option>
                                        <option value="2">银行卡</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">收款账号</label>
                                <div class="layui-input-block">
                                    <input lay-verify="account_number" id="account_number" type="text" name="account" class="layui-input" placeholder="请输入收款账号">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">收款人姓名</label>
                                <div class="layui-input-block">
                                    <input lay-verify="name" id="name_of_payee" type="text" name="account_name" class="layui-input">
                                    <p class="notice">(收款人姓名必须与账号实名一致否则无法打款)</p>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">身份证号</label>
                                <div class="layui-input-block">
                                    <input lay-verify="idCard" id="id_number" type="text" name="idCard" class="layui-input">
                                    <p class="notice">(身份证号必须与姓名匹配否则无法提交)</p>
                                </div>
                            </div>
                            <!-- //展示二维码 -->
                            <img width="248px" id="my_gathering_code" style="margin-left: 240px" src="" alt="">
                            <!-- 收款二维码  input file -->
                            <button type="button" class="layui-btn buttonStyle" id="uploadImage">
                                <i class="layui-icon">&#xe67c;</i>上传收款二维码
                            </button>
                            <div class="layui-form-item">
                                <div class="layui-input-block" style="margin-top: 25px;padding-left: 115px">
                                    <button class="layui-btn buttonStyle" lay-submit lay-filter="confirm_save" type="button" id="confirm_save">确认保存</button>
                                    <button id="delete_info" class="layui-btn buttonStyle" lay-submit lay-filter="set_websites" type="button">删除收款方式重新填</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<p class="bgColor" id="shieldingLayer"></p>
<div class="popup_main">
    <p class="delete_tip">删除收款方式以便重新填写</p>
    <div class="phone_number_box">
        <p>身份验证手机号：</p>
        <input type="number" id="phone_nums" value="" readonly>
    </div>
    <div class="phone_number_box" style="margin-top: 20px;">
        <p>图片验证码：</p>
        <input type="text" id="yzCcode" style="width: 65%;" class="input-val">
        <div style="display: inline-block;float: right;margin-top: 6px;margin-right: 5px;">
            <canvas id="canvas" width="100" height="43"></canvas>
        </div>
    </div>
    <div class="phone_number_box" style="margin-top: 20px;">
        <p>短信验证码：</p>
        <input type="number" id="sms_codes" style="width: 65%;">
        <div style="display: inline-block;float: right;margin-top: 6px;margin-right: 5px;">
           <p class="buttonStyle send_code_btn" style="color: #FFFFFF;" id="send_code">发送验证码</p>
        </div>
    </div>
    <div class="bottom_btn_box">
        <p id="affirm_delete">确认删除</p>
        <p style="margin-right: 20px;" id="close_popup">关闭</p>
    </div>
</div>


</body>
<script src="../../layuiadmin/layui/layui.js"></script>

<script>
    let verify = false;
    let phone_number;
    let sms_code_plus;
    layui.use(['form','upload'], function () {
        var $ = layui.$,
            upload = layui.upload,
            form = layui.form;//只有执行了这一步，部分表单元素才会修饰成功

        //获取短链接
        get_pay_link();
        function get_pay_link() {
            $.ajax({
                url: parent.baseUrl + "/users/shorturl1",//接口地址
                dataType: 'json',
                type: "post",  //类型
                data: {
                    url: parent.baseUrls + '/Purchase_page/goumai_page_main.html',
                    token: localStorage.getItem("token")
                },
                success: function (ret) {
                    if (ret.code === "200") {
                        if( ret.data != null ){
                            $("#short_link").text(ret.data.url_short);
                        }
                    } else {
                        layer.msg(ret.msg);
                    }
                }
            });
        }
        //获取用户基本信息接口
        get_basic_information();
        function get_basic_information() {
            $.ajax({
                url: parent.baseUrl + "/users/shopInfo",//接口地址
                dataType: 'json',
                type: "post",  //类型
                data: {
                    token: localStorage.getItem("token")
                },
                success: function (ret) {
                    console.log(ret);
                    if (ret.code === "200") {
                        if( ret.data != null ){
                            let datas = ret.data;
                            phone_number = ret.data.mobile;
                            form.val("userForm",{
                                "user_number": datas.id,
                                "user_name": datas.username,
                                "e_mail": datas.email,
                                "phone_number": datas.mobile,
                                "user_qq": datas.qq,
                                "my_link": datas.site_url,
                                "site_url": datas.site_url,
                                "shop_name": datas.shop_name,
                                "shop_natice": datas.shop_biref,
                                "pay_type": datas.pay_type,
                            });
                        }
                    } else {
                        layer.msg(ret.msg)
                    }
                }
            });
        }

        //左侧表单提交
        form.on('submit(submit_data)', function(data){
            // console.log(data.field);
            let filed = data.field;
            filed["token"] = localStorage.getItem("token");
            $.post( parent.baseUrl + "/index/upInfo",filed,function(res){
                console.log(res);
                if( res.code === "200" ){
                    layer.msg(res.msg,{icon: 1});
                }else{
                    layer.msg(res.msg,{icon: 2});
                }
            },'json');
            //一定要阻止表单跳转
            return false;
        });

        //监听select的值  做判断
        form.on('select(billing_method)', function(data){
            // console.log(data.value);
            if( data.value === "2" ){
                $("#uploadImage").hide()
            }else if( data.value === "1" ){
                $("#uploadImage").show()
            }else if( data.value === "3" ){
                $("#uploadImage").show()
            }
        });

        //执行实例  上传图片
        var uploadInst = upload.render({
            elem: '#uploadImage' //绑定元素
            ,url: parent.baseUrl + '/Gatherinfo/upImgUrl'//上传接口
            ,images: "images"//只允许上传图片
            ,acceptMime: 'image/*'//点击弹出文件夹里只显示图片格式文件
            ,data: {
                token:localStorage.getItem("token"),
                type: 1,
            }
            ,done: function(res){
                if( res.code === "200" ){
                    $("#my_gathering_code").attr("src",res.data);
                }else {
                    layer.msg(res.msg);
                }
                console.log(res);
            }
            ,error: function(){
                //请求异常回调
            }
        });

        /* 自定义验证规则 */
        form.verify({
            user_qq: function (value) {
                if (value === "" ) {
                    return 'qq号为必填项';
                }
            },
            user_name: function (value) {
                if (value === "" ) {
                    return '请输入商户名称';
                }
            },
            account_number: function (value) {
                if (value === "" ) {
                    return '收款账号为必填项';
                }
            },
            name: function (value) {
                if (value === "" ) {
                    return '收款姓名为必填项';
                }
            },
            idCard: function (value) {
                if (value === "" ) {
                    return '请输入身份证号';
                }
            },
        });



        //右侧表单提交
        form.on('submit(confirm_save)', function(data){
            console.log(data.field);
            let filed = data.field;
            filed["token"] = localStorage.getItem("token");
            $.post( parent.baseUrl + "/Gatherinfo/addInfo",filed,function(res){
                console.log(res);
                if( res.code === "200" ){
                    layer.msg(res.msg,{icon: 1});
                    view_details();
                }else{
                    layer.msg(res.msg,{icon: 2});
                }
            },'json');
            //一定要阻止表单跳转
            return false;
        });

        //查看详情
        view_details();
        function view_details() {
            $.ajax({
                url: parent.baseUrl + "/Gatherinfo/getInfo",//接口地址
                dataType: 'json',
                type: "post",  //类型
                data: {
                    token: localStorage.getItem("token")
                },
                success: function (ret) {
                    console.log(ret);
                    if ( ret.code === "200" ) {
                        $("#payment_term").attr("disabled",true);
                        form.render('select');
                        $("#account_number").attr("readonly","readonly");
                        $("#name_of_payee").attr("readonly","readonly");
                        $("#id_number").attr("readonly","readonly");
                        if( ret.data != null ){
                            let datas = ret.data;
                            $("#my_gathering_code").attr("src",datas.image);
                            form.val("paymentTerm",{
                                "gath_type": datas.gath_type,
                                "account": datas.account,
                                "account_name": datas.account_name,
                                "idCard": datas.idCard,
                            });
                        }
                    } else if( ret.code === "-1" ){
                        $("#payment_term").attr("disabled",false);
                        form.render('select');
                        $("#account_number").removeAttr("readonly").val("");
                        $("#name_of_payee").removeAttr("readonly").val("");
                        $("#id_number").removeAttr("readonly").val("");
                        $("#my_gathering_code").attr("src","");
                    }
                }
            });
        }
        // 点击弹出弹窗
        $("#delete_info").click(function () {
            $("#shieldingLayer").show(200);
            $(".popup_main").css("visibility","visible");
            $("#phone_nums").val(phone_number);
        });
        //点击背景关闭弹窗
        $("#shieldingLayer").click(function () {
            $("#shieldingLayer").hide();
            $(".popup_main").css("visibility","hidden");
        });
        //点击关闭按钮关闭弹窗
        $("#close_popup").click(function () {
            $("#shieldingLayer").hide();
            $(".popup_main").css("visibility","hidden");
        });
        //删除收款信息接口
        function delete_info() {
            $.ajax({
                url: parent.baseUrl + "/Gatherinfo/delMess",//接口地址
                dataType: 'json',
                type: "post",  //类型
                data: {
                    token: localStorage.getItem("token")
                },
                success: function (ret) {
                    console.log(ret);
                    if ( ret.code === "200" ) {
                        var index = layer.alert('删除成功', function(){
                            $("#shieldingLayer").hide();
                            $(".popup_main").css("visibility","hidden");
                            $("#yzCcode").val("");
                            $("#sms_codes").val("");
                            layer.close(index);
                        });
                        view_details();
                    }
                }
            });
        }
        //图片验证码js
        $(function () {
            var show_num = [];
            draw(show_num);

            $("#canvas").on('click', function () {
                draw(show_num);
            });

            $("#yzCcode").blur(function () {
                var val = $(".input-val").val().toLowerCase();
                var num = show_num.join("");
                if ( val == '' ) {
                    verify = false;
                    layer.msg('请输入验证码！');
                } else if ( val == num ) {
                    verify = true;
                } else {
                    layer.msg('验证码错误！请重新输入！');
                    $(".input-val").val('');
                    draw(show_num);
                    return false
                }
            });
        });
        function draw(show_num) {
            var canvas_width = $('#canvas').width();
            var canvas_height = $('#canvas').height();
            var canvas = document.getElementById("canvas");//获取到canvas的对象，演员
            var context = canvas.getContext("2d");//获取到canvas画图的环境，演员表演的舞台
            canvas.width = canvas_width;
            canvas.height = canvas_height;
            var sCode = "A,B,C,E,F,G,H,J,K,L,M,N,P,Q,R,S,T,W,X,Y,Z,1,2,3,4,5,6,7,8,9,0";
            var aCode = sCode.split(",");
            var aLength = aCode.length;//获取到数组的长度

            for (var i = 0; i <= 3; i++) {
                var j = Math.floor(Math.random() * aLength);//获取到随机的索引值
                var deg = Math.random() * 30 * Math.PI / 180;//产生0~30之间的随机弧度
                var txt = aCode[j];//得到随机的一个内容
                show_num[i] = txt.toLowerCase();
                var x = 10 + i * 20;//文字在canvas上的x坐标
                var y = 20 + Math.random() * 8;//文字在canvas上的y坐标
                context.font = "bold 23px 微软雅黑";

                context.translate(x, y);
                context.rotate(deg);

                context.fillStyle = randomColor();
                context.fillText(txt, 0, 0);

                context.rotate(-deg);
                context.translate(-x, -y);
            }
            for (var i = 0; i <= 5; i++) { //验证码上显示线条
                context.strokeStyle = randomColor();
                context.beginPath();
                context.moveTo(Math.random() * canvas_width, Math.random() * canvas_height);
                context.lineTo(Math.random() * canvas_width, Math.random() * canvas_height);
                context.stroke();
            }
            for (var i = 0; i <= 30; i++) { //验证码上显示小点
                context.strokeStyle = randomColor();
                context.beginPath();
                var x = Math.random() * canvas_width;
                var y = Math.random() * canvas_height;
                context.moveTo(x, y);
                context.lineTo(x + 1, y + 1);
                context.stroke();
            }
        }

        function randomColor() {//得到随机的颜色值
            var r = Math.floor(Math.random() * 256);
            var g = Math.floor(Math.random() * 256);
            var b = Math.floor(Math.random() * 256);
            return "rgb(" + r + "," + g + "," + b + ")";
        }


        //短信验证接口
        $("#send_code").click(function () {
            if( !verify ){
                layer.msg('请输入验证码!');
                return false;
            }
            var countdown = 60;
            settime($(this));
            function settime(obj) {
                if (countdown == 0) {
                    $(obj).removeAttr("disabled");
                    $(obj).text("获取验证码");
                    $(obj).css({"pointer-events": "", "color": "#fff"});
                    countdown = 60;
                    return;
                } else {
                    $(obj).attr("disabled", true);
                    $(obj).text(countdown + 's' + '后重发');
                    $(obj).css({"pointer-events": "none", "color": "#ccc"});
                    countdown--;
                }
                setTimeout(function () {
                    settime(obj)
                }, 1000)
            }
            $.ajax({
                url: parent.baseUrl + "/sms/SendSms",
                type: 'POST',
                dataType: 'json',
                data: {
                    mobile: phone_number,
                    type: 6,
                    event: "delPayMess",
                },
                success: function (ret) {
                    console.log(ret);
                    if ( ret.code === "200" ) {
                        sms_code_plus = ret.data;
                        layer.msg('' + ret.msg + '')
                    } else {
                        layer.msg(ret.msg)
                    }
                }
            });
        });

        // 点击确认删除按钮执行删除方法
        $("#affirm_delete").click(function () {
            var sms_codes1 = $("#sms_codes").val();
            if( sms_codes1 === '' ){
                layer.msg("请输入短信验证码");
                return false;
            }else if( sms_code_plus != sms_codes1 ){
                layer.msg("短信验证码不正确");
                return false;
            }
            if( verify ){
                delete_info();
            }
        });

        window.go_shopping = function () {
            layer.confirm('确定更换商铺链接吗？', {
                btn: ['确定','取消'] //按钮
            }, function(){
                alert('确定');
            }, function(){
                alert('取消');
            });
        }
    });
</script>
</html>