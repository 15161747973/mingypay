<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>重置密码</title>
        <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
        <script src="js/jquery-3.3.1.js"></script>
        <link rel="stylesheet" href="css/swiper.min.css" />
        <link rel="stylesheet" type="text/css" href="css/layer.css" />
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
        <link rel="stylesheet" href="css/animate.css">
        <style>
            body {
                padding: 0;
                margin: 0;
                width: 100%;
                /*height: 1000px;*/
                min-width: 1065px;
            }
            @media screen and (max-width: 1000px) {
                .titleOrder{background-color: red}
            }
            .mukuai img {
                width: 100%;
            }

            .navbar ul li a:after {
                content: "";
                width: 0;
                height: 1px;
                position: absolute;
                top: 75%;
                left: 50%;
                transition: all .5s;
                border-bottom: 2px solid #FFFFFF;
            }

            .navbar li a:hover:after {
                left: 25%;
                width: 50%;
                text-align: center;
            }

            .collapse {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 90%;
                height: 70px;
            }

            .my-navbar a {
                background: transparent !important;
                color: #fff !important;
                font-size: 1.2em;
            }

            .my-navbar a:hover {
                background: transparent;
                outline: 0
            }

            .navbar-nav>li>a {
                padding-top: 15px;
                padding-bottom: 15px;
                padding-left: 20px;
                padding-right: 20px;
            }

            .nav-left {
                width: 300px;
                margin-right: 400px;
            }

            .my-navbar2 a {
                background: transparent !important;
                color: #333 !important;
                font-size: 1.2em;
            }

            .my-navbar2 a:hover {
                background: transparent;
                outline: 0
            }

            .navbar2 ul li a:after {
                content: "";
                width: 0;
                height: 1px;
                position: absolute;
                top: 75%;
                left: 50%;
                transition: all .5s;
                border-bottom: 2px solid #000000;
            }

            .navbar2 li a:hover:after {
                left: 25%;
                width: 50%;
                text-align: center;
            }

            .foot h4 {
                font-weight: 100;
                font-family: "Microsoft YaHei", Arial;
                line-height: 1.34;
                color: #000000;
            }

            .foot p {
                color: #666;
                font-size: 15px;
                line-height: 35px;
            }

            .loginBoxs {
                margin-top: 9px;
                display: flex;
                color: #FFFFFF;
                font-size: 18px;
                width: 156px;
                justify-content: space-between;
                /*margin-left:5px;*/
            }

            .bgImages{
                background-image: url("image/bgImage.png");
                background-size: 100% 100%;
                background-repeat: no-repeat;
                width: 100%;
                height:937px;
                text-align: center;
                padding-top: 130px;
            }
            .loginBox{width: 600px;border-radius: 15px;margin: 0px auto;background-color: #FFFFFF;padding-bottom: 10px}
            .WelcomeTo{text-align: center;font-size: 25px;color: #000000;padding-top: 30px}
            .userNameBox{display: flex;margin-top: 20px;margin-left: 80px}
            .userNameBox>p{font-size: 18px;color: #333333;margin-top: 10px;width: 119px;text-align: right}
            .userNameBox>input{border: none;outline: none;font-size: 16px;color: #333333;margin-left: 40px;width: 300px;}
            .userNameBoxs{display: flex;margin-top: 20px;margin-left: 80px}
            .messageCode{font-size: 18px;color: #333333;margin-top: 12px;width: 131px}
            .userNameBoxs>input{border: none;outline: none;font-size: 16px;color: #333333;margin-left: 26px;width: 150px}
            .line{border-top: 1px solid #eeeeee;width: 70%;margin-top: 0}
            .lines{border-top: 1px solid #eeeeee;width: 70%;margin-top: 0px}
            .loginBtn{background: linear-gradient(to right, #3864f9, #708ffa);color: #FFFFFF;font-size: 18px;text-align: center;width: 30%;margin: 0 auto;padding: 8px 0;border-radius: 10px;margin-top: 30px}
            .sendCode{background: linear-gradient(to right, #3864f9, #708ffa);font-size: 14px;color: #FFFFFF;border-radius: 30px;margin-top: 13px;padding: 5px 10px}
            .userNameBox{
                width: 100%;}
            .loginBtns {
                border-radius: 20px;
                width: 60%;
                text-align: center;
                margin-left: 10px;
                background: linear-gradient(to right, #ff6a3c, #ff2953);
                padding: 6px 0;
            }
            #canvas{
                margin-left: -213px;
            }
        </style>
    </head>

    <body>
    <div style="position: absolute;z-index: 1113;width: 100%">
        <nav class="navbar navbar-top my-navbar" role="navigation">
            <div class="collapse container">
                <div class="nav-left"><img src="image/logo.png" alt="" /></div>
                <div class="nav-right navbar-collapse" id="example-navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li>
                            <a href="index.html">网站首页</a>
                        </li>
                        <li>
                            <a href="Serve.html">公司简介</a>
                        </li>
                        <li>
                            <a href="Case.html">联系我们</a>
                        </li>
                        <li>
                            <a href="viewpoint.html">订单查询</a>
                        </li>
                    </ul>
                    <div class="loginBoxs">
                        <p class="loginBtns" onclick="toLogin()">登录</p>
<!--                        <p class="registerBtns" onclick="toRegister()">注册</p>-->
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <div class="bgImages">
        <div class="loginBox">
            <p class="WelcomeTo">重置密码</p>
            <div style="text-align: center">
                <div class="userBoxs">
                    <div class="userNameBox">
                        <p>邮箱：</p>
                        <input id="email" type="text" placeholder="请输入用户名/邮箱">
                    </div>
                    <hr class="line">
                    <p id="errorShow" style="position: absolute;top: 0">123123123</p>
                </div>
                <div class="userBox">
                    <div class="userNameBox">
                        <p>验证码：</p>
                        <input id="Yz_code" type="text" placeholder="请输入验证码" class="input-val">
                        <div>
                            <canvas id="canvas" width="100" height="43"></canvas>
                        </div>
                    </div>
                    <hr class="line">
                </div>
                <div class="userBox">
                    <div class="userNameBoxs">
                        <p class="messageCode">短信验证码：</p>
                        <input id="sms_code_main" type="text" placeholder="请输入短信验证码">
                        <div>
                            <p class="sendCode" id="send_code">发送验证码</p>
                        </div>
                    </div>
                    <hr class="lines">
                </div>
                <div class="userBox">
                    <div class="userNameBox">
                        <p>新密码：</p>
                        <input id="new_password" type="password" placeholder="请输入密码">
                    </div>
                    <hr class="line">
                </div>
                <div class="userBox">
                    <div class="userNameBox">
                        <p>确认新密码：</p>
                        <input id="affirm_password" type="password" placeholder="请输入密码">
                    </div>
                    <hr class="line">
                </div>
            </div>
            <p class="loginBtn" onclick="reset_passwords()">确认</p>
        </div>
    </div>
    </body>

    <script src="js/swiper.min.js"></script>
    <script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/important.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="layer/layer.js"></script>
    <script src="js/baseUrl.js"></script>
    <script type="text/javascript">
        let phoneNum;
        let sms_code;
        //上方导航栏底部横线
        setInterval(function() {
            var a = parseInt($(document).scrollTop());
            /*$("#a").text(a)*/
            if(a >= 600) {
                $(".navbar2").css("top", "0px").css("opacity", "1");
            } else {
                $(".navbar2").css("top", "-50px").css("opacity", "0");
            }
        });
        //页面跳转
        $("#ImmediatelyQuery").click(function () {
            window.location.href = 'complaintInformation.html'
        });

        //跳转登录页面
        function toLogin(){
            window.location.href = 'login.html'
        }
        //跳转注册页面
        function toRegister(){
            window.location.href = 'register.html'
        }
        function toForgetPassword() {
            window.location.href = 'forgetPassword.html'
        }
        //跳转注册页面
        function toRegister(){
            window.location.href = 'register.html'
        }

        function toLogin() {
            window.location.href = 'login.html'
        }
        //默认显示弹出层
        // $("#shieldingLayer").show(500)
        // $("#popups").show(500)
        //点击背景弹窗消失
        $("#consentBtn").click(function () {
            $("#shieldingLayer").hide()
            $("#popups").hide()
        });

        //验证码js
        $(function () {
            var show_num = [];
            draw(show_num);
            $("#canvas").on('click', function () {
                draw(show_num);
            });
            $("#Yz_code").blur(function () {
                var val = $(".input-val").val().toLowerCase();
                var num = show_num.join("");
                if ( val == '' ) {
                    layer.msg('请输入验证码！');
                } else if ( val == num ) {
                    // layer.alert('注册成功！去登录');
                    // $(".input-val").val('');
                    // draw(show_num);
                } else {
                    layer.msg('验证码错误！请重新输入！');
                    $(".input-val").val('');
                    draw(show_num);
                    return false
                }
            });

        });
        function draw(show_num) {
            var canvas_width = $('#canvas').width();
            var canvas_height = $('#canvas').height();
            var canvas = document.getElementById("canvas");//获取到canvas的对象，演员
            var context = canvas.getContext("2d");//获取到canvas画图的环境，演员表演的舞台
            canvas.width = canvas_width;
            canvas.height = canvas_height;
            var sCode = "A,B,C,E,F,G,H,J,K,L,M,N,P,Q,R,S,T,W,X,Y,Z,1,2,3,4,5,6,7,8,9,0";
            var aCode = sCode.split(",");
            var aLength = aCode.length;//获取到数组的长度

            for (var i = 0; i <= 3; i++) {
                var j = Math.floor(Math.random() * aLength);//获取到随机的索引值
                var deg = Math.random() * 30 * Math.PI / 180;//产生0~30之间的随机弧度
                var txt = aCode[j];//得到随机的一个内容
                show_num[i] = txt.toLowerCase();
                var x = 10 + i * 20;//文字在canvas上的x坐标
                var y = 20 + Math.random() * 8;//文字在canvas上的y坐标
                context.font = "bold 23px 微软雅黑";

                context.translate(x, y);
                context.rotate(deg);

                context.fillStyle = randomColor();
                context.fillText(txt, 0, 0);

                context.rotate(-deg);
                context.translate(-x, -y);
            }
            for (var i = 0; i <= 5; i++) { //验证码上显示线条
                context.strokeStyle = randomColor();
                context.beginPath();
                context.moveTo(Math.random() * canvas_width, Math.random() * canvas_height);
                context.lineTo(Math.random() * canvas_width, Math.random() * canvas_height);
                context.stroke();
            }
            for (var i = 0; i <= 30; i++) { //验证码上显示小点
                context.strokeStyle = randomColor();
                context.beginPath();
                var x = Math.random() * canvas_width;
                var y = Math.random() * canvas_height;
                context.moveTo(x, y);
                context.lineTo(x + 1, y + 1);
                context.stroke();
            }
        }

        function randomColor() {//得到随机的颜色值
            var r = Math.floor(Math.random() * 256);
            var g = Math.floor(Math.random() * 256);
            var b = Math.floor(Math.random() * 256);
            return "rgb(" + r + "," + g + "," + b + ")";
        }


        //失去焦点调用获取手机号接口，根据邮箱获取手机号接口
        $("#email").blur(function(){
            var email1 = $("#email").val();
            if( email1 === '' ){
                layer.msg("请输入邮箱地址");
                return false;
            }
            $.ajax({
                url: baseUrl + "/users/getPhoByEmail",
                type: 'POST',
                dataType: 'json',
                data: {
                    email: email1
                },
                success: function (ret) {
                    console.log(ret);
                    if ( ret.code === "200" ) {
                        phoneNum = ret.data;
                    }else{
                        layer.msg("该账号不存在");
                    }
                }
            });
        });

        //短信验证接口
        $("#send_code").click(function () {
            var countdown = 60;
            settime($(this));
            function settime(obj) {
                if (countdown == 0) {
                    $(obj).removeAttr("disabled");
                    $(obj).text("获取验证码");
                    $(obj).css({"pointer-events": "", "color": "#fff"});
                    countdown = 60;
                    return;
                } else {
                    $(obj).attr("disabled", true);
                    $(obj).text(countdown + 's' + '后重发');
                    $(obj).css({"pointer-events": "none", "color": "#ccc"});
                    countdown--;
                }
                setTimeout(function () {
                    settime(obj)
                }, 1000)
            }
            $.ajax({
                url: baseUrl + "/sms/SendSms",
                type: 'POST',
                dataType: 'json',
                data: {
                    mobile: phoneNum,
                    type: 3,
                    event: "resetPwd",
                },
                success: function (ret) {
                    console.log(ret);
                    if ( ret.code === "200" ) {
                        sms_code = ret.data;
                        layer.msg('' + ret.msg + '')
                    } else {
                        layer.msg(ret.msg)
                    }
                }
            });
        });

        $(document).keydown(function(event){
            if( event.keyCode === 13 ){
                reset_passwords();
            }
        });

        //重置密码接口
        function reset_passwords() {
            var email1 = $("#email").val();
            var sms_code_main1 = $("#sms_code_main").val();
            var new_password1 = $("#new_password").val();
            var affirm_password1 = $("#affirm_password").val();

            //判断密码不能少于六个字符
            if( new_password1.length < 6 ){
                layer.msg("新密码不能少于六位");
                return false
            }

            //判断两次密码是否一致
            if ( new_password1 !== affirm_password1 ) {
                layer.msg("两次密码不一致");
                return false
            }

            // 判断短信验证码是否和输入的一致

            if (sms_code_main1 === '') {
                layer.msg("请输入短信验证码");
                return false;
            } else if (sms_code_main1 != sms_code) {
                layer.msg("短信验证码错误");
                return false;
            }
            $.ajax({
                url: baseUrl + "/users/resetpwd",
                type: 'POST',
                dataType: 'json',
                data: {
                    email: email1,
                    code: sms_code_main1,
                    newPwd: new_password1,
                    reNewPwd: affirm_password1,
                },
                success: function (ret) {
                    console.log(ret);
                    if ( ret.code === "200" ) {
                        layer.msg('' + ret.msg + '');
                        if( ret.data != null ){
                            setTimeout(function () {
                                window.location.href = 'login.html';
                            },1500);
                        }
                    } else {
                        layer.msg(ret.msg);
                    }
                }
            });
        }


    </script>

</html>